---
import Layout from "../../layouts/Layout.astro";
import { supabase } from '../../lib/supabase';
const postId = Astro.url.pathname.split('/').pop();
const { data: post } = await supabase
  .from('posts')
  .select('*')
  .eq('id', postId)
  .single();
const { data: comments } = await supabase
  .from('comments')
  .select('*')
  .eq('post_id', postId);
const accessToken = Astro.cookies.get("sb-access-token");
const refreshToken = Astro.cookies.get("sb-refresh-token");
if (!accessToken || !refreshToken) {
  return Astro.redirect("/signin?redirectTo=" + Astro.url.pathname);;
}
const { error } = await supabase.auth.setSession({
  refresh_token: refreshToken.value,
  access_token: accessToken.value,
});
if (error) {
  Astro.cookies.delete("sb-access-token", {
    path: "/",
  });
  Astro.cookies.delete("sb-refresh-token", {
    path: "/",
  });
  return Astro.redirect("/signin?redirectTo=" + Astro.url.pathname);
}
---


<Layout title={post.title} >
  <h1 class="text-3xl font-bold mb-4">{post.title}</h1>
  <p class="mb-6">{post.content}</p>
  <h2 class="text-2xl font-semibold mb-4">Comments</h2>
  <ul class="space-y-4 mb-6">
    {comments && comments.map(comment => (
      <li class="p-4 bg-gray-100 rounded-lg text-black">{comment.content}</li>
    ))}
  </ul>
  <form action="/api/post/new-comment" method="post" class="space-y-4">
    <input type="hidden" name="post_id" value={postId} />
    <textarea name="content" placeholder="Add a comment" required class="w-full p-2 border border-gray-300 rounded-lg text-black"></textarea>
    <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">Comment</button>
  </form>
</Layout>
